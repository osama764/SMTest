<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Home</title>
    <link rel="stylesheet" href="../css/all.min.css">
    <link rel="stylesheet" href="../css/bootstrap.min.css">
    <link rel="stylesheet" href="../css/AddNewRooms.css">
    <link rel="stylesheet" href="../css/all.min.css">
  </head>
  <body>
    <h1 class="p-4">Now Can You Add New Rooms for your Smart Home</h1>

    <div class="container contentDescription mt-3 p-3">
      <div class="description w-50">
        <h2 class="fs-1 mb-3" style="  text-shadow: 0 0 10px #fff;">Add New
          Rooms</h2>
        <p class="fs-4 w-75">Now you can add new rooms in your smart home, visit
          each room and control its devices</p>
        <button class="addRoom">Add Room</button>

      </div>
      <!-- animation using lottiefiles -->
      <div class="lotifile">
        <lottie-player
          src="https://lottie.host/7f84f947-0a96-4837-bcdf-0eb7bef8ff4c/5RePCOQRbt.json"
          speed="1" loop autoplay direction="1" mode="normal" class="p-2"
          style="background-color: #fff;border-radius: 8px;"></lottie-player>
      </div>
    </div>

    <div
      class="container d-flex align-items-center justify-content-between mt-3 p-5 contentAddRoom">

      <div class="AddRooms">

        <h2 class>Add New Room</h2>
        <label for="nameRoom" class="fs-5 mb-2">Name Room :</label>
        <input type="text" id="nameRoom" name="nameRoom" class="p-2 mb-2">

        <label for="nameRoom" class="fs-5 mb-2 mt-2">Image Room :</label>
        <div
          class=" d-flex align-items-center justify-content-evenly w-100 mb-2 mt-2">
          <input type="text" id="imageRoom" name="imageRoom"
            class="p-2 mb-2 mt-1" class="w-75">
          <button class="w-25  ms-3 select btn btn-warning "
            style="font-weight: 600;">select</button>
        </div>

        <input type="button" value="Add Room"
          style="color: black; font-weight: 600;" class="addNewRoom">

      </div>
      <div>
        <button class="close btn btn-warning " style="font-weight: 700;">X</button>
        <lottie-player class="animationAddRoom"
          src="https://lottie.host/e104bd32-da8f-4554-9797-b75bc7ac664e/3iKZhohEd8.json"
          background="#FFFFFF" speed="1" style="width: 300px; height: 300px"
          loop autoplay direction="1" mode=“normal”></lottie-player>
      </div>

    </div>

    <div class="contentRooms">
    </div>

    <div id="containerImage">
      <span id="closeImages">X</span>
      <h2>Images the Rooms</h2>
      <div class="containerSelectionImages">

      </div>

    </div>

    <script
      src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
    <script src="../js/jquery_3.7.0.js"></script>
    <script src="../js/popper.js"></script>
    <script src="../js/bootstrap_5.3.0.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <!-- <script src="../AddNewRooms.js"></script> -->

    <script>
      // configuration of Project 
const firebaseConfig = {
  apiKey: "AIzaSyC1pII7CHpUYKDELsSO6QV6AllnIUutCqg",
  authDomain: "smart-home-fb189.firebaseapp.com",
  databaseURL: "https://smart-home-fb189-default-rtdb.firebaseio.com",
  projectId: "smart-home-fb189",
  storageBucket: "smart-home-fb189.appspot.com",
  messagingSenderId: "395648266554",
  appId: "1:395648266554:web:1d9ec392d8c14ca6272003"
};

firebase.initializeApp(firebaseConfig);
// Get a reference to  RealTime Database service
const database = firebase.database();

// the browser will speech during lading page AddingRoom
function welcomeInRoom() {
  let welcomeMessage = new SpeechSynthesisUtterance(
    "Now you can add new rooms in your smart home"
  );
  let speech = window.speechSynthesis;
  welcomeMessage.rate = 0.7;
  speech.speak(welcomeMessage);
}

// calling function  welcomeInRoom()
window.onload = welcomeInRoom();

let addRoom = document.querySelector(".addRoom");
let contentAddRoom = document.querySelector(".contentAddRoom");
let close = document.querySelector(".close");

// button add New Room will appear form to add data of this Room
addRoom.addEventListener("click", (e) => {
  e.preventDefault();
  contentAddRoom.style.transform = "translateX(0vw)";
});

// this button will close form (adding data of Room)
close.addEventListener("click", (e) => {
  e.preventDefault();
  contentAddRoom.style.transform = "translateX(120vw)";
});

// initialization variables to use later
let nameRoom     = document.getElementById("nameRoom");
let imageRoom    = document.getElementById("imageRoom");
let addNewRoom   = document.querySelector(".addNewRoom");
let contentRooms = document.querySelector(".contentRooms");
let body         = document.querySelector("body");

// this button will add New Room in container Rooms after take data of this Room
addNewRoom.addEventListener("click", (e) => {
  e.preventDefault(); // To prevent the page from loading 

  // To ensure that the data is correct
  if (imageRoom.value != "" && nameRoom.value != "") {
    // calling Function add Room in RealTime Database in Firebase
    addNewRoomInFirebase();
    // close form and browser will speech that Room added 
    contentAddRoom.style.transform = "translateX(120vw)";
    let welcomeMessage = new SpeechSynthesisUtterance(
      "A new room has been added"
    );
    let speech = window.speechSynthesis;
    welcomeMessage.rate = 0.7;
    speech.speak(welcomeMessage);
  } else {
    // if data of Room can't correct will appear message above form ( color Red )
    let h5 = document.createElement("h5");
    h5.innerHTML = "Please Enter Data Correct !!";
    h5.classList = "alertMessage";
    contentAddRoom.prepend(h5);

    // Remove message after 3 seconds
    setTimeout(() => {
      let deletAlert = document.querySelector(".alertMessage");
      deletAlert.remove();
    }, 3000);
  }
});

// function add new Room in RealTime Database in firebase
function addNewRoomInFirebase() {

  // Taking the values ​​from the input fields for the room name and the room photo 
  nameRoom = $("#nameRoom").val();
  imageRoom = $("#imageRoom").val();

  // add values in this Object to send data to RealTime Database
  var data = {
    Name: nameRoom,
    image: imageRoom,
    devices: [],
    devicesPush: [],
  };

  // this function is plugin from jQuery to add Data in RealTime Database
  $.ajax({
    // url ===> my Project in RealTime Database
    url: "https://smart-home-fb189-default-rtdb.firebaseio.com/Rooms.json",
    method: "POST",
    data: JSON.stringify(data), // Add data after converting from object to String
    contentType: "application/json; charset=UTF-8",
    dataType: "json",
    success: function () {
      clearForm(); // calling function Clear Form
      alert("Data saved successfully");
      DisplayData() // Calling function display data from RealTime 
    },
    error: function () {
      alert("Failed to save Data");
    },
  });
}

// this function will delete values from input fields 
function clearForm() {
  $("#nameRoom").val("");
  $("#imageRoom").val("");
}

// this function will display all Rooms From RealTime Database 
function DisplayData() {
  $.ajax({
    url: "https://smart-home-fb189-default-rtdb.firebaseio.com/Rooms.json",
    method: "GET",
    dataType: "json",
    success: function (data) {
      contentRooms.innerHTML = "";

      for (var room in data) {
        let card = `
          <div  class="card border-0 p-3 m-2 text-center" style="background-image: url(../images/${data[room].image}.jpg);">
          <i class="fa-solid fa-trash-can deletbtnThisRoom"></i>
            <h3 class="mt-3 mb-3 room__title">${data[room].Name}</h3>
            <button class="btn btn-warning  visit">Visit</button>
            <span style="opacity:0">${room}</span> 
          </div>
        `;
        contentRooms.innerHTML += card;
      }
    },
    error: function () {
      alert("Failed to load Data");
    },
  });
}

// calling function display during loading Page
window.onload = DisplayData();

// this is container for all Rooms
contentRooms.addEventListener("click", (e) => {
  
  // the Element that contains classes : ( card  border-0   p-3 m-2   text-center )


  if (e.target.classList == "btn btn-warning  visit") {

    // Fetching room data via this current element on which the event takes place
    const nameImage = e.target.parentElement.style.backgroundImage
    const nameRoom =
    e.target.parentElement.lastElementChild.previousElementSibling.previousElementSibling
    .innerHTML

    // Encrypt the data and send it to the home page in the url
    const encodedImage = encodeURIComponent(nameImage);
    const encodedName = encodeURIComponent(nameRoom);
    // path Home Page
    const url = 
      "ShowMyRooms.html?nameRoom=" +
      encodedName +
      "&nameImage=" +
      encodedImage;
    window.location.href = url;
  }

    // the Element that contains classes : ( fa-solid  fa-xmark  deletbtnThisRoom )
  if (e.target.classList == "fa-solid fa-trash-can deletbtnThisRoom") {
  
    // uid is id that use to delete this Room 
    let uid = e.target.parentElement.lastElementChild.innerHTML
    // passing uid in function to delete this Room
    deleteRoom(uid)
    // delete this Room from Dom ( static )
    e.target.parentElement.remove();
   }




})


let selectImage = document.querySelector(".select");
let closeImages = document.querySelector("#closeImages");

// button select image
selectImage.addEventListener("click", function (e) {
  e.preventDefault();
  containerImage.style.transform = " scale(1)";
});

// close list of Images
closeImages.addEventListener("click", function (e) {
  e.preventDefault();
  containerImage.style.transform = " scale(0)";
});

let containerSelectionImages = document.querySelector(
  ".containerSelectionImages"
);

// for loop ( 12 image ) : 12 is not fixed, it changes according to the number of images
for (let i = 1; i <= 6; i++) {
  let newImage = `
<div class="cardImage">
<img src="../images/${i}.jpg" alt="">
<span>${i}</span>
</div>
`;
  containerSelectionImages.innerHTML += newImage;
}

const images = document.querySelectorAll(".cardImage img");

// in click any image will take name for this image and close List of Images
images.forEach(function (image) {
  image.addEventListener("click", function (event) {
    if (event.target.tagName.toLowerCase() === "img") {
      const card = event.target.closest(".cardImage");
      const span = card.querySelector("span");
      imageRoom.value = span.textContent;
      containerImage.style.transform = " scale(0)";
    }
  });
});

// this function use to delete Room by id
function deleteRoom(uid) {
  $.ajax({
      url:`https://smart-home-fb189-default-rtdb.firebaseio.com/Rooms/${uid}.json`,
      method:"DELETE",
      success:function () {
          alert("Room deleted successfully");
      },
      error:function () {
          alert("Failed to delete Room");
      }
  });
}

    </script>

  </body>
</html>
